# mewc-predict

## Introduction
This repository contains code to build a Docker container for running mewc-predict. This is a tool used to perform inferencing for classifying species from camera trap images. The classification engine used in mewc-train is EfficientNetV2. The tool relies on a trained model file that is generated by mewc-train. Additionally you will need to have pre-processed your images with MegaDetector and have the output JSON file available. You will need to have snipped out the images of the animals to detect using mewc-snip which should place these snipped images in a subdirectory of your image directory called `snips`.

You can supply arguments via an environment file where the contents of that file are in the following format with one entry per line:
```
VARIABLE=VALUE
```

## Usage

After installing Docker you can run the container using a command similar to the following. The `--env CUDA_VISIBLE_DEVICES=0` and `--gpus all` options allow you to take advantage of GPU accelerated training if your hardware supports it. Substitute `"$INPUT_DIR"` for your image directory that contains  and create a text file `"$ENV_FILE"` with any config options you wish to override. 

```
docker pull zaandahl/mewc-predict:v1.0
docker run --env CUDA_VISIBLE_DEVICES=0 --gpus all \ 
    --env-file "$ENV_FILE" \
    --interactive --tty --rm \
    --volume "$INPUT_DIR":/images \
    zaandahl/mewc-predict
```

## Config Options

The following environment variables are supported for configuration (and their default values are shown). Simply omit any variables you don't need to change and if you want to just use all defaults you can leave `--env-file $ENV_FILE` out of the command alltogether. 


| Variable | Default | Description |
| ---------|---------|------------ |
| INPUT_DIR | "/images/" | A mounted point containing images to process - must match the Docker command above |
| MD_FILE | "md_out.json" | MegaDetector output JSON file, must be located in INPUT_DIR |
| EN_FILE | "en_out.pkl" | EfficientNetV2 output PKL file, must be located in INPUT_DIR |
| EN_CSV | "en_out.csv" | CSV file containing EfficientNetV2 output, must be located in INPUT_DIR |
| RENAME_SNIPS | True | Rename snipped images to a random string of characters after processing |
| SNIP_DIR | "snips" | A subdirectory under INPUT_DIR to find snipped images |
| SNIP_CHARS | 16 | Number of random characters to use when renaming snipped images |
| TARGET_SIZE | 240 | Target size for EfficientNetV2 input |
| BATCH_SIZE | 256 | Batch size for EfficientNetV2 input |
| TOP_CLASSES | True | Output only top classes for each image |

